用`进程调度状态`、`进程调度`和`一个指向上一个睡眠进程PCB的指针`实现了进程在共享资源时的睡眠等待与唤醒机制，分别包装成睡眠和唤醒两个函数。

此逻辑非常简单，但不太容易被理解。

### 1 进程等待资源的睡眠
[1] 初始一个用于某资源共享的PCB指针为NULL，表征之前无进程睡眠等待；

[2] 在睡眠函数栈中保存该PCB指针，置PCB指针指向当前进程的PCB；置当前进程状态为不可调度状态，随即调度进程调度函数完成进程调度；

[3] 在调用`进程调度函数`之后唤醒（置回可调度状态）栈中所保存PCB所指进程。

这个过程有3个要点：

[1] 睡眠函数栈在`调度函数`返回前一直存在；

[2] `调度函数`的返回依赖于当前进程被唤醒后；

[3] 当前进程被唤醒即`调度函数`返回后，立即唤醒在该进程之前睡眠的进程。

是的，每一处都是要点。

### 2 进程的唤醒
唤醒睡眠等待的进程时，只需唤醒最后一个进入睡眠的进程（即1中提到的PCB所指向的进程），让被唤醒进程依次唤醒之前睡眠等待的进程。

### 3 等待资源进程的睡眠与唤醒过程
```C
[1] 3个进程依次通过PCB进入睡眠等待
PCB = NULL;
+----------------+         +->+---------------+         +->+---------------+
|t = PCB         |         |  |t = PCB        |         |  |t = PCB        |
+----------------+         |  +---------------+         |  +---------------+
|PCB = PCB1      |         |  |PCB = PCB2     |         |  |PCB = PCB3     |
+----------------+         |  +---------------+         |  +---------------+
|PCB1 unrunning  |         |  |PCB2 unrunning |         |  |PCB3 unrunning |
| && schedule    |run other|  | && schedule   |run other|  | && schedule   |
+----------------+---------+  +---------------+---------+  +---------------+
|t(NULL)  running|            |t(PCB1) running|            |t(PCB2) running|
+----------------+            +---------------+            +---------------+
P1                            P2                           P3
PCB指向最后一个进入睡眠进程的PCB即PCB3

[2] 唤醒最后一个进入睡眠等待的进程，然后各进程被依次唤醒
wake_up: PCB running; PCB = NULL
   |
   |   +----------------+    +---------------+    +---------------+
   |   |t = PCB         |    |t = PCB        |    |t = PCB        |
   |   +----------------+    +---------------+    +---------------+
   |   |PCB = PCB1      |    |PCB = PCB2     |    |PCB = PCB3     |
   |   +----------------+    +---------------+    +---------------+
   |   |PCB1 unrunning  |    |PCB2 unrunning |    |PCB3 unrunning |
   |   | && schedule    |    | && schedule   |    | && schedule   |
   +-->+----------------+ +->+---------------+ +->+---------------+
       |t(PCB2)  running| |  |t(PCB1) running| |  |t(NULL) running|
       +----------------+ |  +---------------+ |  +---------------+
       |      ...       |-+  |       ...     |-+  |       ...     |
       P3                   P2                  P1
```